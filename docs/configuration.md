# Configuration Reference

Complete reference for all configuration options in preview-deployer.

## Repository Configuration (`preview-config.yml`)

Place this file in your repository root to configure preview deployments.

### Required Fields

```yaml
# Framework selection
framework: nestjs  # Options: nestjs, go

# Database type
database: postgres  # Options: postgres, mysql, mongodb

# Health check endpoint path
health_check_path: /health  # Path to health check endpoint
```

### Optional Fields

```yaml
# Custom build commands (run before container start)
build_commands:
  - npm install
  - npm run build
  - npm run test

# Environment variables (passed to application container)
env:
  - NODE_ENV=preview
  - DEBUG=true
  - API_KEY=value

# Custom Dockerfile path (relative to repo root)
dockerfile: ./Dockerfile

# Database seeding
seed:
  - type: sql
    file: ./seed.sql
  - type: command
    command: npm run seed
```

## CLI Configuration (`~/.preview-deployer/config.yml`)

Generated by `preview init`. Sensitive values are stored in OS keychain.

```yaml
digitalocean:
  token: keychain  # Stored in OS keychain
  region: nyc3
  droplet_size: s-2vcpu-4gb

github:
  token: keychain  # Stored in OS keychain
  webhook_secret: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
  repositories:
    - owner/repo-name

orchestrator:
  cleanup_ttl_days: 7
  max_concurrent_previews: 10
```

## Environment Variables

### Orchestrator Service

Set in Ansible or systemd service file:

```bash
# GitHub Configuration
GITHUB_TOKEN=ghp_xxxxxxxxxxxx
GITHUB_WEBHOOK_SECRET=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
ALLOWED_REPOS=owner/repo1,owner/repo2

# Preview Configuration
PREVIEW_BASE_URL=http://YOUR_SERVER_IP
CLEANUP_TTL_DAYS=7
MAX_CONCURRENT_PREVIEWS=10

# Server Configuration
ORCHESTRATOR_PORT=3000
NODE_ENV=production

# Deployment Paths
DEPLOYMENTS_DIR=/opt/preview-deployments
NGINX_CONFIG_DIR=/etc/nginx/preview-configs
DEPLOYMENTS_DB=/opt/preview-deployer/deployments.json

# Logging
LOG_LEVEL=info  # Options: debug, info, warn, error
```

## Terraform Variables

Set in `terraform/terraform.tfvars`:

```hcl
do_token       = "your-digital-ocean-api-token"
ssh_public_key = "ssh-rsa AAAA..."
region         = "nyc3"  # Options: nyc1, nyc3, sfo3, ams3, etc.
droplet_size   = "s-2vcpu-4gb"  # Options: s-1vcpu-2gb, s-2vcpu-4gb, s-4vcpu-8gb
project_name   = "preview-deployer"
```

### Available Regions

- `nyc1`, `nyc3`: New York
- `sfo3`: San Francisco
- `ams3`: Amsterdam
- `sgp1`: Singapore
- `lon1`: London
- `fra1`: Frankfurt
- `tor1`: Toronto
- `blr1`: Bangalore

### Available Droplet Sizes

- `s-1vcpu-2gb`: $12/month
- `s-2vcpu-4gb`: $24/month (default)
- `s-4vcpu-8gb`: $48/month
- `s-8vcpu-16gb`: $96/month

## Ansible Variables

Set via `-e` flag or in playbook:

```yaml
deployment_user: preview-deployer
orchestrator_dir: /opt/preview-deployer
orchestrator_port: 3000
github_token: ghp_xxxxxxxxxxxx
github_webhook_secret: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
allowed_repos: owner/repo1,owner/repo2
server_ip: 1.2.3.4
preview_base_url: http://1.2.3.4
cleanup_ttl_days: 7
max_concurrent_previews: 10
```

## Docker Compose Templates

Templates are located in `orchestrator/templates/`:

- `docker-compose.nestjs.yml.hbs`: NestJS application template
- `docker-compose.go.yml.hbs`: Go application template

### Template Variables

- `{{prNumber}}`: PR number
- `{{appPort}}`: Allocated app port
- `{{dbPort}}`: Allocated database port

### Container Resources

Default limits (configurable in templates):

```yaml
deploy:
  resources:
    limits:
      cpus: '0.5'
      memory: 512M
    reservations:
      cpus: '0.25'
      memory: 256M
```

## Nginx Configuration

Preview configs are generated in `/etc/nginx/preview-configs/`:

```nginx
location /pr-{PR_NUMBER}/ {
    proxy_pass http://localhost:{APP_PORT}/;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection 'upgrade';
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_cache_bypass $http_upgrade;
    proxy_read_timeout 300s;
    proxy_connect_timeout 75s;
}
```

## Health Check Configuration

Your application must expose a health check endpoint:

### NestJS Example

```typescript
@Controller()
export class AppController {
  @Get('health')
  health() {
    return { status: 'ok' };
  }
}
```

### Go Example

```go
func healthHandler(w http.ResponseWriter, r *http.Request) {
    w.WriteHeader(http.StatusOK)
    w.Write([]byte(`{"status":"ok"}`))
}
```

The orchestrator will poll this endpoint until it returns 200 OK.

## Custom Dockerfiles

If your repository has a custom Dockerfile, ensure it:

1. Exposes the correct port (3000 for NestJS, 8080 for Go)
2. Includes a health check endpoint
3. Runs as non-root user (recommended)
4. Handles SIGTERM gracefully

### Example Dockerfile (NestJS)

```dockerfile
FROM node:20-alpine

WORKDIR /app

COPY package*.json ./
RUN npm ci --production

COPY . .
RUN npm run build

EXPOSE 3000

USER node

CMD ["node", "dist/main.js"]
```

## Database Configuration

### PostgreSQL (Default)

```yaml
database: postgres
```

Connection string format:
```
postgresql://preview:preview@db:5432/pr_{PR_NUMBER}
```

### MySQL

```yaml
database: mysql
```

Connection string format:
```
mysql://preview:preview@db:3306/pr_{PR_NUMBER}
```

### MongoDB

```yaml
database: mongodb
```

Connection string format:
```
mongodb://preview:preview@db:27017/pr_{PR_NUMBER}
```

## GitHub Webhook Configuration

Webhooks are automatically created by the CLI. Manual configuration:

1. Go to repository Settings > Webhooks
2. Add webhook:
   - **Payload URL**: `http://YOUR_SERVER_IP/webhook/github`
   - **Content type**: `application/json`
   - **Secret**: From `~/.preview-deployer/config.yml`
   - **Events**: Select "Pull requests"
   - **Active**: Checked

## Logging Configuration

### Orchestrator Logs

Location: `/opt/preview-deployer/logs/`

- `orchestrator.log`: Application logs
- `orchestrator-error.log`: Error logs

View logs:
```bash
ssh root@YOUR_SERVER_IP
journalctl -u preview-deployer-orchestrator -f
```

### Docker Logs

View container logs:
```bash
docker logs pr-{PR_NUMBER}-app
docker logs pr-{PR_NUMBER}-db
```

### Nginx Logs

Location: `/var/log/nginx/`

- `access.log`: Access logs
- `error.log`: Error logs

## Troubleshooting Configuration

See [Troubleshooting Guide](troubleshooting.md) for common configuration issues.
